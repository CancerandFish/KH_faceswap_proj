# KH_faceswap_proj

ğŸ“¢ä¸­è‹±æ–‡å¤¹æ‚æ³¨æ„

ğŸ‘ğŸ»Welcome to the project page!

<img src="https://github.com/CancerandFish/KH_faceswap_proj/blob/main/results/poster_lyt_htt.png" width="100" alt="poster"/><br/>


<!-- ![poster](https://github.com/CancerandFish/KH_faceswap_proj/blob/main/results/poster_lyt_htt.png) -->

This project is only a simple turtorial that introduces my small try on faceswap. Big thanks for é˜¿ç¾ŠğŸ‘ï¼Œæ¿è“æ ¹ğŸ‘§ğŸ»ï¼Œæ—è€å¸ˆğŸºï¼ŒæŸè¯ºğŸ‘§ğŸ» and all the people that encourage me and take part in the project.

Your suggestions are alwayas welcome. You can contact me any time by leave your issues here.


æœ¬é¡¹ç›®ä»…ä»¥æ•™è‚²ã€å­¦ä¹ ä¸ºç›®çš„è¿›è¡Œ. æ¬¢è¿ä»»ä½•å»ºè®®.

æˆ‘è§‰å¾—è¿™ä¸ªé¡¹ç›®åº”è¯¥å¥–åŠ±æˆ‘ä¸¤æ–¤å†³æ˜å­æ³¡èŒ¶å–ï¼ˆ






<!-- ## éœ€è¦äººå·¥çš„åœ°æ–¹

å©·å§å…«å›¾
- å¾®åšå…«å›¾
- ç”Ÿå†™ç…§ç‰‡å…«å›¾
- æ´—å›¾

cxxæ•°æ®é›†å¤„ç†
- ä¸‹è½½ä¸€äº›é™ˆæ˜Ÿæ—­cutèµ„æº æˆ‘æ¥å¤„ç†äººè„¸
- ç­›é™ˆæ˜Ÿæ—­è®­ç»ƒé›†ï¼ˆåˆ é™¤å…¶ä»–äººç‰©ã€ä¸åˆæ ¼äººè„¸ç­‰

èŠ±é¦™
- è§†é¢‘èµ„æºä¸‹è½½ï¼ˆmp4æ ¼å¼ è´¨é‡å°½é‡å¥½ è­¬å¦‚æ— æ ‡ç­‰ï¼‰
- ä¸¤ä½å¥³ä¸»å¾®åšã€facebookç­‰å…«å›¾

## è¿›åº¦



### æ€»è¿›åº¦ -->

<!-- 12.9

åœ¨450k iteræ—¶åœæ­¢äº†original modelçš„è®­ç»ƒï¼Œå¹¶è¿›è¡Œæµ‹è¯•ï¼ˆæ„Ÿè°¢0è€å¸ˆæä¾›è§†é¢‘æºæ–‡ä»¶

ç¬¬ä¸€æµ‹ç»“æœä¸å¥½ï¼Œä¸»è¦é—®é¢˜æ€»ç»“ï¼š

1. é¢éƒ¨ä¸å¤Ÿæ¸…æ™°ã€‚
2. èƒŒæ™¯è¾¹ç¼˜ä¹Ÿè·Ÿç€äººè„¸è¢«æ¨¡ç³Šã€‚
3. é¢é¥°

é’ˆå¯¹ä»¥ä¸Šé—®é¢˜æå‡ºçš„è§£å†³æ–¹æ³•ï¼š

1. æ¢æ¨¡å‹ï¼Œoriginal model çš„inputå’Œoutputå‡ä¸º64xã€‚ç°åœ¨æ”¹ç”¨Dlight (128px input, 128-384px output), Dlight is a higher resolution model based on the dfaker variant, focusing on upscaling the faces, with custom upscalers. This is the newest model and is very easily configurable. æœ€æ–°è€Œä¸”easy.
2. åŠ äº†vgg-clear maskåï¼Œé¢éƒ¨è½®å»“å’Œbackgroundè½®å»“å¯ä»¥æ¸…æ¥šåˆ†å¼€ã€‚è¿™ä¸ªç®—æ˜¯å·²ç»ç¡®è®¤è§£å†³ã€‚
3. é¢é¥°è¿™é‡Œâ€¦â€¦å§‘ä¸”è°ƒäº†legacyæ¯”ä¾‹ï¼Œè¯•è¯•çœ‹å§ã€‚

12.8

- æ”¶é›†å¸åèµ„æºï¼šç”Ÿå†™æ‰«å›¾ã€å¤œè¶mvç­‰ ï¼ˆæ„Ÿè°¢é˜¿ç¾Š æŸè¯ºï¼

- æ¸…æ´—å¸åå›¾åŒ…ã€‚
  - æå¡é¥­æ‹æ‰«å›¾å…±æå–+1357å¼ 

- æ”¶é›†é™ˆæ˜Ÿæ—­å½­å°è‹’èµ„æºï¼šå¾®åšä¸ªç«™ç­‰ ï¼ˆæ„Ÿè°¢é˜¿ç¾Šï¼
  - å½­å°è‹’å›¾åŒ…

- æå–å¤œè¶mvå¸åå›¾ç‰‡ï¼Œæ··åœ¨ä¸€èµ·è¿˜éœ€è¦äººå·¥åˆ†ï¼Œä¸å¥½ã€‚
  - å°è¯•åŠ maskè¿›è¡Œåˆ†ç±»æå– - å˜æ…¢äº†ã€‚
  - å¸§é—´å·®è·å¤ªå° - ä»£ç è‡ªåŠ¨skipï¼Œ5å¸§ç•™1.
  - æ¸…æ´—åçº¦æ”¶é›†å¸åå„+200å¼ 


12.7

- æ‘¸äº†

12.6 

- çˆ¬å–â€˜æè‰ºå½¤â€™å›¾ç‰‡ï¼Œå‘½ä»¤1000ï¼ŒæˆåŠŸ702ï¼›æ¸…æ´—åï¼š490~

- çˆ¬å–â€˜snh48 é»„å©·å©·â€™å›¾ç‰‡ï¼Œå‘½ä»¤3000ï¼ŒæˆåŠŸ755ï¼›æ¸…æ´—åï¼š402 ï¼ˆæ¸…æ´—æ„Ÿè°¢æ—è€å¸ˆ

- çˆ¬å–â€˜é»„å©·å©·â€™å›¾ç‰‡ã€‚on goingã€‚

- çˆ¬å–â€˜é™ˆæ˜Ÿæ—­â€™å›¾ç‰‡ã€‚è‰ï¼Œä»–è¿™ä¹ˆç³Šå—ä¸è‡³äºå•Šï¼Œåªçˆ¬å‡ºäº†470+å›¾ç‰‡ï¼Œç›®æµ‹å››åˆ†ä¹‹ä¸€è¿˜å¸¦ç€å¼ å©§ä»ªã€‚

- çˆ¬å–â€˜å½­å°è‹’â€™å›¾ç‰‡ã€‚462å¼ ã€‚è¡Œå§ï¼Œä½ ä¿©ä¹ŸæŒºé…ã€‚

<!-- - çˆ¬å–â€˜Song Hye-gyoâ€™å›¾ç‰‡ï¼Œ -->

<!-- - çˆ¬å–â€˜æ—è¾°å”â€™ã€‚ã€‚

- çˆ¬å–â€˜ç¨‹äºˆå¸Œâ€™ã€‚ã€‚ -->



<!-- 






### æå¡-pxr è®­ç»ƒè¿›åº¦
![1209è°ƒè¯•å›¾](https://github.com/CancerandFish/KH_faceswap_proj/blob/main/results/12091321-Training%20-%20'S':%20Save%20Now.%20'R':%20Refresh%20Preview.%20'M':%20Toggle%20Mask.%20'ENTER':%20Save%20and%20Quit_screenshot_09.12.2021.png)

12.9. 

14:02 åœäº†ä¸€ä¸‹è®­ç»ƒï¼Œè¯•å›¾éªŒè¯ä¸€ä¸‹ç»“æœã€‚

Iterations: 473579, loss A: 0.03037; loss B: 0.03123

\[Saved models\] Average loss since last save: face_a: 0.02618, face_b: 0.02572 --> -->


## Training samples collection

Some tips for face data:

As required/suggested by faceswap official guidelines, we are asked to gather 

- around **500 to 5000** faces for each subject
- should be of a **high quality** and contain **a wide variety of angles, expressions and lighting conditions**.
- **do not** extract every single frame from a video for training as from frame to frame the faces will be very similar.

So in this section, we first start to introduce our face sources, each of which is followed by the invloved collecting methods in detail. 

As lyt and htt is so bonded together â¤ï¸, their parts will be merged. 

### Source collection

#### Lyt and Htt

- Video:
  - å¡é»„ç”µè§†å‰§cutç´ æï¼ˆç°ä»£å‰§ã€Šé€†è¢­ã€‹ï¼‰ï¼Œmp4 formatï¼Œå…¶ä½™äººè„¸å¹²æ‰°æœ‰ï¼Œmanually cleaned
  - httå•äººç”µè§†å‰§cutç´ æï¼Œå¤è£…å‰§ã€Šç´ æ‰‹é®å¤©ã€‹, manually cleaned
  
- Imagesï¼š
  - google crawling
  - å¡é»„å„ç±»æ‰«å›¾åˆé›†ã€‚lack in side faces
  - å¡é»„unitã€soloç­‰æ¼”å”±ä¼šfocusï¼Œgood qualityï¼Œä½†å…‰ç…§è¡£ç€è§’åº¦å‡å•ä¸€ã€‚å…¶ä½™äººè„¸å¹²æ‰°æœ‰ï¼Œmanually cleaned


#### CXX and PXR

- Imagesï¼š
  - æœ¬äººå¾®åšã€æœ¬äººä¸ªç«™
  - google crawling
  
- Videosï¼š
  - ä¸œå®«å‰16é›†cut, manually cleaned

#### Summary

|Name|Number of Valid Training Samples|Source|
|--|--|--|
|lyt|2055-3200|è°·æ­Œã€å›¾åŒ…ã€å¤œè¶mvã€é€†è¢­|
|htt|707|è°·æ­Œã€å¤œè¶mv|
||2074|sushou|
||809|nixi_02_34|
||404|nixi_35_over|
||305|scanned pictures|
|pxr|2315|è°·æ­Œã€weibo|
|cxx|1212|donggong|
||1762|weibo, google|


### Google images crawling

- codes availableï¼šhttps://github.com/hardikvasa/google-images-download

But this version has a bug (at least for me Linux 20.04

- å·²ç»è§£å†³issueçš„æ­£ç¡®ç‰ˆæœ¬ï¼šhttps://github.com/Joeclinton1/google-images-download
- å®‰è£…æ–¹æ³•
```
$ git clone https://github.com/Joeclinton1/google-images-download.git
$ cd google-images-download
$ sudo python setup.py install
```
- å®‰è£…chromedriver, https://sites.google.com/chromium.org/driver/downloads?authuser=0

- å‘½ä»¤è¡Œæ‰§è¡Œï¼š 
```
$ googleimagesdownload --keywords "Polar bears" --limit 200 -cd /Users/tianran/Downloads/chromedriver
```

### Video extracting suggestions
I use built-in functions in faceswap to extract faces inside the video. I list some tricks here:

-  use single person cut instead of the whole video, especially when your target is not the main actor/actoress
-  use 1080p video sources
-  set extract frame interval to be ~40 to meet the **diversity** requirements
-  set `min_size = 256`, to extract only clear and large faces
-  use sort, a built-in functions in faceswap, before you manually remove the other faces you do not want to remain in your training set


## Let's begin swapping

### Codes and environment intalling
My environment:
- Serverï¼šLinux Ubuntu 20.04 + 4 * V100
- Desktopï¼šLinux 20.04 + 1 * 1080 Ti

Codes fromï¼šhttps://github.com/deepfakes/faceswap/blob/master/USAGE.md#Gathering-raw-data

Some patent and ethitical requirementsï¼š
- FaceSwap is not for creating inappropriate content.
- FaceSwap is not **for changing faces without consent or with the intent of hiding its use**.
- FaceSwap is not for any illicit, unethical, or questionable purposes.
- FaceSwap exists to experiment and discover AI techniques, for social or political commentary, for movies, and for any number of ethical and reasonable uses.


### Training

I first try the original model, some problems I encountered: 
- the results tend to be a little blurring, even when I turn the sharp config to max...
- å½­å°è‹’çš„é¢é¥°ç»å¸¸ä¼šè¢«æ¨¡ç³Šæ‰
- è¾¹ç¼˜ä¸å¤Ÿæ¸…æ¥š

è§£å†³åŠæ³•ï¼š
- Then I try the DFL model, which takes a 128x128 px image as the input and outputs 256x256 px image. 
- é’ˆå¯¹é¢é¥°ï¼Œæˆ‘ä½¿ç”¨äº†legacyè€Œéfaceè¿›è¡Œç•Œé™åˆ’å®šï¼Œå¯¹äºlyt-pxrè¿™ä¸ªpairï¼Œå‡å°‘è„¸éƒ¨è¯†åˆ«åŒºåŸŸçš„èŒƒå›´ã€‚ç»“æœæå‡å·¨å¤§ï¼Œé¢é¥°å¤§å¤šæ—¶å€™èƒ½å¤Ÿè¢«ç²¾å‡†åˆ†ç±»ã€‚
- åœ¨convertæ—¶ï¼Œæˆ‘ä½¿ç”¨äº†vgg-obstructionè¿›è¡Œé®æŒ¡ç‰©è¯†åˆ«ï¼Œè¿›ä¸€æ­¥åˆ†å¼€äº†é¢é¥°å’Œäººè„¸ã€‚
- é’ˆå¯¹è¾¹ç¼˜ä¸å¤Ÿæ¸…æ¥šçš„é—®é¢˜ï¼Œåˆ†æåŸå› åœ¨äºä¾§è„¸samplesè¿‡å°‘ï¼Œä½†å—é™äºæ—¶é—´ï¼Œæ— æ³•è¿›è¡Œä¿®æ­£ã€‚å› æ­¤åœ¨converté˜¶æ®µï¼Œæˆ‘å¯¹äºä¸ªåˆ«ä¾§è„¸éƒ¨åˆ†è¿›è¡Œerosionè®¾ç½®ï¼Œä½¿è¿™é‡Œçš„è¾¹ç¼˜ä½¿ç”¨pxræœ¬äººçš„è½®å»“ï¼Œæ›¿ä»£ç”Ÿæˆçš„è½®å»“ï¼Œä»¥æ­¤äº§ç”Ÿæ¸…æ™°çš„è¾¹ç¼˜ã€‚

![poster](https://github.com/CancerandFish/KH_faceswap_proj/blob/main/results/comparison.png)

### è§†é¢‘æ¢è„¸

Originalæ¨¡å‹ä½¿ç”¨1080Tiä¸»æœºå³å¯è¿è¡Œï¼Œè®­ç»ƒçº¦è€—æ—¶1å¤©å·¦å³ã€‚å…¶è¾“å‡ºä¸º64x64 px.

è€ŒDFLæ¨¡å‹è¾“å‡ºè¾ƒOriginalå¤§16å€ï¼Œè€ƒè™‘åˆ°ç½‘ç»œæ·±åº¦å’Œå®½åº¦çš„ä¸åŒï¼Œå…¶è®­ç»ƒæ—¶é—´æ¯”è¾ƒé•¿ï¼Œä¸€å¼ 1080tiçš„å†…å­˜ä¹Ÿå¾ˆéš¾è¾¾æ ‡ã€‚å› æ­¤ï¼Œæˆ‘å°†DFLæ”¾äºServerè¿ç®—ï¼Œä»¥4å¼ 32G V100è¿›è¡Œè®­ç»ƒï¼Œçº¦è€—æ—¶4å¤©å·¦å³ã€‚

### Some results

After 450k iters, Lyt-pxr's results:

![lyt-pxr](https://github.com/CancerandFish/KH_faceswap_proj/blob/main/results/lyt_result.jpg)

After 300k iters, Htt-cxx's results:

![lyt-pxr](https://github.com/CancerandFish/KH_faceswap_proj/blob/main/results/htt_result.jpg)


## é™„å½•
### äººå·¥æ¸…æ´—æ‰‹å†Œï¼ˆver0 åˆæ­¥ï¼‰

æ‰€æœ‰å›¾ç‰‡å‘½åè§„åˆ™ï¼šæ•°å­—åºå·+å›¾ç‰‡å+æ‰©å±•åã€‚ä»¥æ•°å­—åºå·è¿›è¡Œç»„å†…ç»Ÿä¸€è¯†åˆ«ï¼Œåˆ‡å‹¿æ›´æ”¹ã€‚åç¼€åå¤šæ ·ï¼Œä¸å½±å“å¤„ç†ç»“æœã€‚

æ ¹æ®ç™¾åº¦ç½‘ç›˜é“¾æ¥ä¸‹è½½å›¾åŒ…ï¼Œå¤„ç†ç»™å®šåºå·å›¾ç‰‡ã€‚

å…·ä½“åœ°ï¼Œè¯·ï¼š
- åˆ é™¤**ä¸åˆæ ¼**å›¾ç‰‡ï¼ˆè§£é‡Šé™„åï¼‰
- é‡æ–°ä¸Šä¼ ç™¾åº¦ç½‘ç›˜ï¼ˆéœ€å‹ç¼©ï¼‰ã€‚

ä¸åˆæ ¼å›¾ç‰‡å®šä¹‰ï¼ˆä»¥æå¡æ–‡ä»¶å¤¹ä¸‹å›¾ç‰‡ä¸ºä¾‹ï¼‰ï¼š

- å›¾ç‰‡ä¸å«æ–‡ä»¶å¤¹å‘½åä¹‹äººç‰©ï¼ˆå¦‚ï¼šæå¡å›¾åŒ…ä¸­æŸå›¾æ— æå¡ï¼‰
- å›¾ç‰‡ä¸­å«æœ‰é™¤æå¡å¤–çš„å…¶ä»–äººçš„æ­£ã€ä¾§è„¸
- è§†è§‰ä¸Šè¿‡äºç³Šï¼Œæ— æ³•è¾¨è®¤å‡ºæ˜¯å¦æ˜¯æå¡æœ¬äºº
- å›¾ç‰‡ä¸­çš„æå¡å¸¦ç€é¢å…·ã€å£ç½©ï¼›é¢éƒ¨è¯†åˆ«åŒºæ— æ³•è¾¨è®¤
- å›¾ç‰‡ä¸­æœ‰ä¸”åªæœ‰æå¡ï¼Œä½†æ­¤æå¡æ¥è‡ªäºæ‰‹æ¸¸å¡é¢
- å›¾ç‰‡æœ‰ä¸”åªæœ‰æå¡ï¼Œä½†æ­¤æå¡æ˜¯ä¸ªç…§ç‰‡ã€ç”Ÿå†™è½¬æ‹

âš ï¸è­¦å‘Šï¼šå°å¿ƒé å©§ç¥ã€èµµç²¤ã€lytã€æ›¾è‰³èŠ¬ã€çº¸ç‰‡äººã€å¸ååˆç…§â€¦â€¦











